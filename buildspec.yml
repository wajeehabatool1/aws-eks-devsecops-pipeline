version: 0.2

env:
  variables:
    SNYK_TOKEN: "fbc76124-10d8-4ef1-9c85-016067774004"

phases:
  install:
    runtime-versions:
      python: 3.9
      golang: 1.18
      nodejs: 18
    commands:
      - echo "Installing dependencies"
      - curl -sSL https://github.com/zricethezav/gitleaks/releases/latest/download/gitleaks-linux-amd64 -o /usr/local/bin/gitleaks
      - chmod +x /usr/local/bin/gitleaks
      - npm install -g snyk

  pre_build:
    commands:
      - echo "Running Gitleaks for secret scanning..."
      - gitleaks detect --source . --verbose --redact || echo "No secrets found"
      - echo "Authenticating Snyk..."
      - snyk auth $SNYK_TOKEN
      - echo "**** SNYK DEPENDENCY SCANNING ****"
      - cd backend
      - echo "Running snyk for dependency scanning for python service"
      - cd customer-registration
      - snyk test || echo "python service snyk scan completed with issues"
      - cd ..
      - echo "Running snyk for dependency scanning for Node.js service"
      - cd order-processing
      - snyk test || echo "Node.js service snyk scan completed with issues"
      - cd ..
      - echo "Running snyk for dependency scanning for Golang service"
      - cd notification
      - snyk test || echo "Golang service snyk scan completed with issues"
      - cd ../..

  build:
    commands:
      - echo "Build phase -------------------"
      # Add your build commands here

  post_build:
    commands:
      - echo "Post build -------------------"
      # Add your post-build commands here
